name: Windows 3rd Parties

on:
  workflow_dispatch

jobs:
  windows-3rd-parties:
    runs-on: windows-2019
    steps:
      - name: Install tools
        shell: cmd
        run: choco install wget curl jq --no-progress

      - name: Git clone
        shell: cmd
        run: |
          cd \
          git config --global core.autocrlf input & git config --global core.eol lf & git clone https://github.com/dynawo/dynawo.git

      - name: Install OpenModelica
        shell: cmd
        run: |
          cd \
          wget -nv https://github.com/gautierbureau/dynawo-windows/releases/download/windows-3rd-parties/OpenModelica.zip
          7z x OpenModelica.zip

      - name: Build Dynawo Third Parties
        shell: cmd
        run: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cd \dynawo
          cmake -Wno-dev -S dynawo/3rdParty -B b-3-p -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=../d-3-p -DOPENMODELICA_INSTALL=../OpenModelica -DOPENMODELICA_SRC=../OpenModelica/Source -DOMDEV_HOME=../OMDev -G "NMake Makefiles"
          cmake --build b-3-p --target omdev
          cmake --build b-3-p --target openmodelica
          cmake --build b-3-p
          cd ..
          ren d-3-p dynawo-3rd-parties-windows
          7z a dynawo-3rd-parties-windows.zip -r dynawo-3rd-parties-windows\*

      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "windows-3rd-parties"
          prerelease: true
          title: "Windows 3rd Parties"
          files: |
            D:\OpenModelica.zip
            D:\dynawo-3rd-parties-windows.zip
